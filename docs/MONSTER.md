# 怪物系统文档

## 概述

怪物（妖魔）是游戏中的敌对单位，会在地图上移动、吞噬草药、入侵地点，甚至袭击宗门。玩家需要派遣弟子完成战斗任务来消灭它们。

## 怪物属性

| 属性 | 说明 |
|------|------|
| `id` | 唯一标识符 |
| `name` | 怪物名称（如：噬魂虎、血影狼） |
| `level` | 等级（影响战斗难度） |
| `is_demon` | 是否成魔（成魔后游戏失败） |
| `growth_rate` | 成长速率 |
| `is_being_fought` | 是否正在被战斗（有弟子接受了针对它的任务） |
| `has_active_defense_task` | 是否有守卫任务锁定 |

## 怪物移动

### 移动规则

每回合怪物有 **50%** 概率选择移动，**50%** 概率选择修行（提升等级）。

### 移动方向

怪物移动**不是纯随机**的，而是倾向于朝目标方向移动：

```
目标优先级：
1. 最近的草药
2. 宗门位置 (10, 10)
```

**方向权重：**
| 方向效果 | 权重 | 说明 |
|---------|------|------|
| 靠近目标 | 5 | 距离减少 |
| 保持距离 | 2 | 距离不变 |
| 远离目标 | 1 | 距离增加 |

**目标选择逻辑：**
- 70% 概率选择距离更近的目标（草药或宗门）
- 30% 概率在草药和宗门之间随机选择
- 如果地图上没有草药，则始终朝宗门移动

### 移动限制

怪物在以下情况下**不会移动**：

1. **正在被战斗** (`is_being_fought = true`)
   - 当有弟子接受了针对该怪物的战斗任务时
   - 任务完成或取消后恢复移动

2. **有守卫任务锁定** (`has_active_defense_task = true`)
   - 当怪物入侵某地点，且有弟子接受了守卫任务时
   - 守卫任务完成或失败后恢复移动

## 怪物行为

### 吞噬草药

当怪物移动到草药所在位置时，会吞噬草药并获得修为提升：

```
修为增益 = 基础值(5) + 品质加成 × 成熟度
```

草药品质加成：
- 普通：+0
- 良品：+3
- 极品：+5
- 仙品：+10

### 入侵地点

怪物移动到村庄、势力或秘境时，会触发入侵事件：
- 生成守卫任务（`守卫{地点名}`）
- 怪物被锁定在该位置
- 入侵期间地点功能受影响

### 袭击宗门

当怪物移动到宗门位置 `(10, 10)` 时：

1. 触发宗门被袭击警告
2. 开始 **6 回合倒计时**
3. 每回合显示剩余时间
4. 倒计时结束前未消灭怪物 → **游戏失败**

```
⚠️ 警告：{怪物名} 已抵达宗门！6回合内必须消灭它，否则游戏失败！
```

### 修行成长

怪物选择修行时：
- **30%** 概率成功修行
- 成功后等级提升
- 等级越高，战斗难度越大
- 达到一定条件可能成魔（`is_demon = true`），导致游戏失败

## 战斗任务

### 讨伐任务

当地图上存在怪物时，自动生成讨伐任务：
- 任务名称：`讨伐{怪物名}#{ID}`
- 任务位置：跟随怪物移动
- 最多 3 人参与

### 战斗成功率

```
成功率 = 基础成功率 × (1 + 弟子战力加成) × (1 - 怪物等级惩罚)
```

影响因素：
- 弟子修为等级
- 弟子天赋（战斗相关）
- 怪物等级
- 参与人数

### 战斗结果

| 结果 | 效果 |
|------|------|
| 成功 | 怪物被消灭，获得奖励（修为、资源、声望） |
| 失败 | 弟子死亡（`constitution = 0`），怪物恢复移动 |

## 代码位置

| 功能 | 文件 | 函数/结构 |
|------|------|----------|
| 怪物结构 | `src/map.rs` | `struct Monster` |
| 移动逻辑 | `src/map.rs` | `fn monster_actions()` |
| 目标选择 | `src/map.rs` | `fn find_monster_target()` |
| 吞噬草药 | `src/map.rs` | `fn monsters_consume_herbs()` |
| 宗门袭击 | `src/map.rs` | `fn check_sect_invasion()` |
| 战斗状态 | `src/map.rs` | `fn set_monster_being_fought()` |
| 任务执行 | `src/interactive.rs` | `fn execute_single_task()` |

## 相关配置

怪物生成配置位于 `config/monsters.json`：

```json
{
  "monster_templates": [
    {
      "name": "噬魂虎",
      "level": 2,
      "is_demon": false,
      "growth_rate": 0.1,
      "position": { "x": 8, "y": 12 },
      "task_templates": [
        {
          "name_template": "讨伐{name}",
          "task_type": "Combat",
          "progress_reward": 15,
          "resource_reward": 40,
          "reputation_reward": 25,
          "dao_heart_impact": 3
        }
      ]
    }
  ],
  "spawn_rules": {
    "spawn_chance": 0.2,
    "level_range": [1, 5],
    "random_names": ["妖兽", "魔狼", "邪灵", "凶兽"]
  }
}
```
